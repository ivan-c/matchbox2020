---
version: "3.4"
x-dnsmasq-base: &dnsmasq_base
  build:
    dockerfile: Dockerfile.dnsmasq
    context: .
  entrypoint:
    - dnsmasq
    - --log-facility=-
    - --keep-in-foreground
    - --user=root

    # disable DNS (port 53)
    - --port=0

services:
  matchbox:
    build:
      dockerfile: Dockerfile.matchbox
      context: .
    volumes:
      - ./matchbox:/tmp/matchbox:ro
      - ./docker-entrypoint.sh:/bin/entrypoint.sh:ro
      - ./docker-entrypoint.d:/docker-entrypoint.d:ro
    environment:
      MATCHBOX_LOG_LEVEL: debug
      MATCHBOX_ADDRESS: 0.0.0.0:8080
    entrypoint: /bin/entrypoint.sh
    command: /bin/matchbox
    env_file: matchbox.env
    ports:
      - 8080:8080

  dhcpd:
    <<: *dnsmasq_base
    # TODO use dhcp relay
    network_mode: host
    command:
      - --log-queries
      - --log-dhcp

      - --dhcp-range=192.168.1.0,proxy

      # if DHCP userclass is iPXE, add ipxe tag
      - --dhcp-userclass=set:ipxe,iPXE

      # 0th request: download Raspberry Pi firmware
      # Raspberry Pi uses the same client-arch as PC BIOS and downloads its own set of files
      # TODO tag/filter by MAC/serial
      - --pxe-service=tag:!ipxe,x86PC,Raspberry Pi Boot,Netboot RaspberryPi,${next_server}

      # 1st request: download iPXE image
      - --pxe-service=tag:!ipxe,x86PC,Boot iPXE with BIOS,ipxe/undionly.kpxe,${next_server}
      - --pxe-service=tag:!ipxe,x86-64_EFI,Boot iPXE with EFI,ipxe/ipxe.efi,${next_server}
      - --pxe-service=tag:!ipxe,ARM64_EFI,Boot iPXE with EFI,ipxe/ipxe.arm64.efi,${next_server}

      # DHCP option 66 (Server-Name) is only populated for dnsmasq pxe-services
      # TODO consolidate to single dhcp-boot entry when host can be parsed from DHCP filename (URL), or manually set DHCP option 66
      # 2nd request: download iPXE script via HTTP and run
      - --pxe-service=tag:ipxe,x86-64_EFI,Boot system-specific iPXE script,http://${server}:8080/boot.ipxe
      - --pxe-service=tag:ipxe,x86PC,Boot system-specific iPXE script,http://${server}:8080/boot.ipxe
      - --pxe-service=tag:ipxe,ARM64_EFI,Boot system-specific iPXE script,http://${server}:8080/boot.ipxe
    ports:
      # DHCP
      - "67:67/udp"

  tftpd:
    <<: *dnsmasq_base
    command:
      - --enable-tftp
      - --tftp-root=/var/lib/tftpboot
    ports:
      - "69:69/udp"

    # TODO build universal (not machine-specific) tftp files into docker image
    # https://github.com/pftf/RPi4/issues/59
    volumes:
      - ./tftpboot:/var/lib/tftpboot

---
version: "3.4"
x-dnsmasq-base: &dnsmasq_base
  build:
    dockerfile: Dockerfile.dnsmasq
    context: .
  entrypoint:
    - dnsmasq
    - --log-facility=-
    - --keep-in-foreground
    - --user=root

services:
  matchbox:
    build:
      dockerfile: Dockerfile.matchbox
      context: .
    volumes:
      - ./:/tmp/matchbox:ro
      - ./docker-entrypoint.sh:/bin/entrypoint.sh:ro
      - ./docker-entrypoint.d:/docker-entrypoint.d:ro
    environment:
      MATCHBOX_LOG_LEVEL: debug
      MATCHBOX_ADDRESS: 0.0.0.0:8080
      MATCHBOX_ASSETS_PATH: /tmp
    entrypoint: /bin/entrypoint.sh
    command: /bin/matchbox
    env_file: matchbox.env
    ports:
      - 8080:8080

  dhcpd:
    <<: *dnsmasq_base
    # todo: use dhcp relay
    network_mode: host
    command:
      - --log-queries
      - --log-dhcp

      - --dhcp-range=192.168.1.0,proxy

      # if DHCP userclass is iPXE, add ipxe tag
      - --dhcp-userclass=set:ipxe,iPXE
      # if DHCP userclass is U-Boot arm64, add uboot tag
      - --dhcp-vendorclass=set:uboot,U-Boot.armv8



      # raspberry pi; does not support iPXE
      # 1st request: download raspberry pi firmware, loads U-Boot via TFTP
      - --pxe-service=tag:!ipxe,0,Raspberry Pi Boot,Netboot RaspberryPi,start.elf,${next_server}

      # 2nd request: download U-Boot config
      - --pxe-service=tag:uboot,0,Raspberry Pi Boot,Netboot RaspberryPi,boot.scr,${next_server}


      # 1st request: download BIOS iPXE image via TFTP and run
      - --pxe-service=tag:!ipxe,x86PC,Boot iPXE with BIOS,undionly.kpxe,${next_server}
      # 1st request: download EFI iPXE image via TFTP and run
      - --pxe-service=tag:!ipxe,x86-64_EFI,Boot iPXE with EFI,ipxe.efi,${next_server}

      # 2nd request: download iPXE script via HTTP and run
      - --pxe-service=tag:ipxe,x86-64_EFI,Boot system-specific iPXE script,http://${next_server}:8080/boot.ipxe
      - --pxe-service=tag:ipxe,x86PC,Boot system-specific iPXE script,http://${next_server}:8080/boot.ipxe
    ports:
      # DHCP
      - "67:67/udp"

  tftpd:
    <<: *dnsmasq_base
    command:
      - --port=0
      - --enable-tftp
      - --tftp-root=/var/lib/tftpboot
    ports:
      - "69:69/udp"
